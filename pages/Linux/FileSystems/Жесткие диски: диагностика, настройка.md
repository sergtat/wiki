#  Жесткие диски: диагностика, настройка
##  Диски в системе
Определим какие жесткие диски есть в системе, какое имя они имеют.
  fdisk -l
Размер диска здесь указан коммерческий (1Tb=1b x 1000 x 1000 x 1000 x 1000).
Узнаем реальный размер
  hdparm -I /dev/sda |grep "device size"
Посмотрим, как можно узнать точки монтирования разделов жесткого диска на текущий момент.
  df -hT
или
  cat /etc/mtab
Ну и что бы наверняка до конца получить общую картину о разделах жестких дисков, определим тип используемых на них файловых систем с помощью утилиты file:
  file /dev/sda1
Можно использовать для определения UUID следующую утилиту:
  blkid
В итоге, теперь мы знаем:
- какие жесткие диски видны в системе
- каким образом они разбиты на разделы
- размер свободного пространства на отформатированной части
- размер свободного пространства на зарезервированной части и размер самих жестких дисков.
- тип файловой системы, UUID раздела
- точки монтирования и состояние (примонтирован или нет) на текущий момент, а также другие опции для монтирования.
##  S.M.A.R.T.
Это технология для самомониторинга, анализа и отчетности по текущему состоянию жесткого диска. Она не говорит нам явно, когда подохнет жесткий диск, она лишь сообщает некоторые наиболее важные статистические данные по факту работы жесткого диска, на основании которого можно сделать те или иные выводы. Для просмотра данных S.M.A.R.T. я предлагаю воспользоваться пакетом smarttools (smartmontools), который входит в состав скорее всего всех уважающих себя дистрибутивов. Пакет представляет из себя набор из двух программ: smartctl и smartd. Посредством первый мы можем вывести S.M.A.R.T. статистику, а с помощью второй(который на самом деле является демоном) - мониторить состояние жесткого диска в реальном времени и даже сообщать в случае чего админу на почту "радостную" весточку. Давайте для начала попробуем посмотреть более подробно состояние вашего жесткого диска:
  smartctl --all /dev/sda
Описание атрибутов S.M.A.R.T. http://ru.wikipedia.org/wiki/S.M.A.R.T.

На современных винчестерах бед блоки ремапятся на аппаратном уровне автоматически, делается это в несколько шагов. С начала сектора на подозрении попадают в очередь Reallocated_Event_Count, в сматрте винта можно посмотреть сколько таких секторов на текущий момент:
  196 Reallocated_Event_Count 0x0032 200 200 000 Old_age Always - 0
если после нескольких проходов диагноз подтверждается, то контроллер винчестера их перемещает в очередь Current_Pending_Sector, параметр в смарте отражает количество таких секторов в очереди:
  197 Current_Pending_Sector 0x0032 200 200 000 Old_age Always - 0
и только после этого такие сектора ремапятся и попадают в таблицу переназначенных секторов, количество таких секторов мы видим в параметре смарта:
  5 Reallocated_Sector_Ct 0x0033 200 200 140 Pre-fail Always - 0
Это в упрощенном варианте. Так что если у Вас во всех трех пунктах значение столбца THRESH не нулевые - значит ваш винчестер активно отбрасывает коньки... Аминь.

Теперь по поводу команды Badblocks. Эта команда просто помечает в существующей файловой системе не заремапленные винчестером bad блоки (либо у винчестера уже закончились резервные сектора, что очень плохо для его дальнейшей жизни, либо система успела наткнутся на bad блок, который винчестер еще не успел спрятать, что значит что скорее всего такой сектор после ремапа будет нормально читаться и писаться). На не отформатированных разделах не работает. Если раздел переформатировать - то нужно будет заново запускать эту утилиту. Или форматировать сразу с опцией отключающей быстрое форматирование, в этом случае форматирование будет происходить с верификацией и все бэдблоки будут занесены в карту диска. До следующего форматирования. :)))

Такая система отметки bad блоков в файловых системах существует со времен появления первых дискет и винчестеров (в те времена винчестеры не умели прятать bad блоки автоматом, да и вообще не умели их прятать).
##  hdparm
  hdparm -t /dev/sda
произведет измерение скорости чтения с диска, и выведет об этом информацию.

Проверим настройки:
  hdparm -i /dev/sda
Здесь нам будет интересна строчка UDMA mode, потому что именно там стоит звездочка перед udma6. Это самый быстрый из режимов, как мы и думали. Режимы PIO и DMA уже морально устарели и на современных компьютерах они уже не используются, разве что если чего глючит. Если вместо ключа "-i" Вы поставите "-I", то вывод будет куда более информативен.

Так же с помощью hdparm можно поменять значение Acusting Managment. Данная настройка позволяет управлять шумом при работе жесткого диска. Как правило ее применяют, если Ваш жесткий диск довольно шумно работает (вой, трещание). Выполните следующую команду, что бы максимально снизить уровень шума вашего жесткого диска:
  hdparm -M 128 /dev/sda
Для того, что бы закрепить результат, необходима в конфигурационном файле /etc/hdparm/conf создать следующие строки:
  /dev/sda {
  acoustic_management = 128
  }
Значение 128 максимально снижает уровень шума, который исходит от жесткого диска. Для того, что бы увеличить быстродействие диска на максимум, установите значение после ключа "-М" на 256(это максимально возможное значение)

Ну и напоследок, как говорится, обрежем хвост жесткому диску. То есть изменим значение HPA(Host Protected Area) или по другому уменьшем область видимых секторов для операционной системы. А для тех, кто совсем в танке, мы просто возьмем так, и оттяпаем кусочек. Зачем это надо? Например, если в конце жесткого диска имеется область с большим количеством bad-блоков, то можно искусственно уменьшить его объем, что бы затем особо не переживать, при разбивке жесткого диска на разделы, что диск захватит не хорошие области. Или вот еще одни момент: некоторые даже довольно современные BIOS не способны нормально определять разделы более 2Тб, а прошивок новых где не вышло, следовательно мы можем временно уменьшить объем жесткого диска, и он хотя бы будет работать. А еще, часто, в таких "закрытых" областях производители компьютеров прячут копию предустановленной системы, что бы потом можно было легко восстановится до заводских настроек. (вы не поверите, это все в man hdparm написано, если что =).

Посмотрим, что у нас с HPA на самом деле:
  hdparm -N /dev/sda
Из "HPA is disabled" следует, что у меня оно отключено. Так же мы видим общее количество секторов(как правило, они по 512 байт), а значит объем жесткого диска будет приблизительно в два раза меньше, что собственно подтверждается на практике, так как он равен 320 Гб. Следовательно, что бы оттяпать 30-40 гигов, мне потребуется ввести значение, на 6000000-8000000 меньше. Для этого введем под рутом такую команду:
  hdparm -N p540000000 /dev/sdc
После ввода такой команды, информация запишется в памяти жесткого диска и раздел останется урезанным даже после перезагрузки. За один сеанс работы жесткого диска можно только один раз вводить данную команду, если нужно еще что-то изменить, то жесткий диск необходимо выключить, а затем включить (по факту - перезагружать компьютер между очередным вводом команды). В команде после ключа "p" идет адрес сектора, следовательно объем жесткого диска мы уменьшили примерно на 30Гб.

Это еще далеко не все возможности программы, и как всегда, я посылаю всех читать официальную документацию, если кому стало интересно разобраться с этим немного поподробнее.

Вообще, если вы хотите получше протестировать состояние жесткого диска, то рекомендую попробовать вам воспользоваться двумя известнейшими на сегодня утилитами для диагностики и тестирования жесткого диска: MHDD и Victoria (обе точно имеют бесплатные версии). Через них же рекомендую производить и remap сбойных секторов, ибо проверено многократно на личном опыте. Не знаю, продолжают ли разрабатывать их дальше, но определенно они предлагают довольно удобный псевдографический интерфейс, правда я встречал их только под DOS, либо MS Windows, тем не менее в сети полно всякие Riscue CD, на которых стоит FreeDOS с ними на пару. В этих ваших интернетах по ним и правда полно информации, но я рекомендую начать с официальной документации, в который вы так же найдете дополнительные материалы по самим жестким дискам.

##  Заключение
В любом случае, если ваш жесткий диск ведет себя в последнее время каким-либо странным образом: постоянно отключается, пропадают файлы, операционная система периодически выпадает в kernel panic или повисает на некоторый промежуток времени - обязательно хорошенько обдумайте, стоит ли использовать такой диск дальше.

Если же вы проверили жесткий диск на сбойные сектора, просмотрели смарт и все вроде бы нормально, но он ведет себя не адекватно. Попробуйте, если еще этого не сделали, пошевелить шлейфы, поменять на однозначно рабочие, переткнуть пару раз. Возможно просто что-то где-то окислилось или пропал контакт. Имеет смысл попробовать вынуть винчестер из компьютера, открутить электронную плату, отвечающую за управление механикой, и банально почистить обычным ластиком контактные площадки, расположенные с внутренней стороны платы. Сразу советую обратить внимание на наличие перегретых областей, сгоревших деталей. Рассмотрите вариант несовместимости с вашей материнской платой (если ставите этот хард в свой компьютер в первый раз), или может быть имеет смысл перевести жесткий диск с режима SATA2 на просто SATA, перекинув перемычку на соседние контакты. Не забывайте, что помимо самого жесткого диска может глючить контроллер на материнской плате (привет чипсетам Nvidia ;-) Ну и уж совсем последним шагом будет попытка перепрошить жесткий диск =), инструкцию ищите на сайте производителя (жаль что в большинстве случаев все будет для опять же для виндов). А если уж Вы совсем решили стать маньяком, то например жесткие диски от компании Seagate и Maxtor можно еще попробовать починить, подключившись к нему в сервисный режим. Это отдельная большая тема, и возможно потребуется умение держать паяльник и работать с последовательным терминалом, подключив жесткий диск к COM-порту. По данному вопрос ищите информацию на ресурсах, подобных например этому - http://rom.by.

Вопрос восстановления жесткого диска до работоспособного в наше время чаще всего риторический. Подумайте сами - HDD в 1Тб в среднем сейчас стоит чуть больше, чем 2 000 деревянных, и убивать несколько недель на ковыряние с почти заведомо дохлым трупом - есть только две адекватные причины для этого - ваш жесткий не заменим на подобный в принципе, либо получения личного удовлетворения от успешно восстановленной железки. Во всех остальных случаях находящийся на издыхании жесткий диск должен быть в использовании не дольше, чем с него будет снята копия необходимых вам данных.
