# Файрвол на базе iptables
##  Установка iptables
Использование Iptables предоставляет возможности:
- пакетной фильтрации сетевого трафика - функции брандмауэра;
- маскировки или преобразования IP-адресов (DNAT, SNAT, MASQUERADE);
- прозрачного проксирования трафика;
- изменения параметров IP-заголовка сетевого пакета (например, изменение параметра TOS - Type Of Service - позволяет установить определенный вариант маршрутизации).
Чтобы установить брандмауэр, включите поддержку Iptables в ядре, а также те опции Iptables, которые вы собираетесь использовать в составе ядра или отдельных модулей. Нужно обратить внимание на перечисленные ниже параметры сборки ядра:

**CONFIG_PACKET** - требуется для приложений, работающих непосредственно с сетевыми устройствами, например tcpdump или snort.  
**CONFIG_NETFILTER** - необходим тогда, когда компьютер служит сетевым экраном (firewall) или шлюзом (gateway) в Интернете.  
**CONFIG_IP_NF_CONNTRACK** - модуль для трассировки соединений, также используется при трансляции сетевых адресов и маскарадинге (NAT и Masquerading). Так что если вы решили строить сетевой экран - брандмауэр для локальной сети, то вам определенно потребуется эта опция.  
**CONFIG_IP_NF_FTP** - модуль трассировки FTP-соединений. Обмен по FTP происходит слишком интенсивно, чтобы можно было использовать обычные методы трассировки.  
**CONFIG_IP_NF_IPTABLES** - необходим для выполнения операций фильтрации, преобразования сетевых адресов (NAT) и маскарадинга (masquerading).  
**CONFIG_IP_NF_MATCH_LIMI**T - модуль не обязателен. Он предоставляет возможность ограничения количества проверок для некоторого правила. Например, -m limit -limit 3/minute указывает, что заданное правило может пропустить не более трех пакетов в минуту. Таким образом, данный модуль способен защитить от нападений типа Отказ в обслуживании.  
**CONFIG_IP_NF_MATCH_MAC** - модуль позволяет строить правила, основанные на MAC-адресации. Поскольку каждая сетевая карта имеет собственный уникальный Ethernet-адрес, то можно блокировать пакеты, поступающие с определенных MAC-адресов, или выполнять привязку IP-адреса к MAC-адресу карты.  
**CONFIG_IP_NF_MATCH_MARK** - необязательная функция маркировки пакетов (MARK). С ее помощью можно помечать требуемые пакеты, а затем в других таблицах в зависимости от значения метки принимать решение о маршрутизации такого пакета.  
**CONFIG_IP_NF_MATCH_MULTIPORT** - модуль позволяет строить правила с проверкой на принадлежность пакета к диапазону номеров портов источника/приемника.  
**CONFIG_IP_NF_MATCH_TOS** - модуль помогает строить правила на основе состояния поля TOS (Type Of Service) в пакете, а также устанавливать или сбрасывать биты этого поля в правилах таблицы mangle.
**CONFIG_IP_NF_MATCH_TCPMSS** - опция добавляет возможность проверки поля MSS для TCP-пакетов.  
**CONFIG_IP_NF_MATCH_STATE** - одно из самых серьезных усовершенствований по сравнению с ipchains. Этот модуль предоставляет возможность управления TCP пакетами на основе их состояния (state).  
**CONFIG_IP_NF_MATCH_UNCLEAN** - модуль реализует проведение дополнительной проверки IP-, TCP-, UDP- и ICMP-пакетов для обнаружения в них несоответствий, <странностей>, ошибок.  
**CONFIG_IP_NF_FILTER** - модуль реализации таблицы filter, где в основном и происходит фильтрация и где находятся цепочки INPUT, FORWARD и OUTPUT. Он обязателен, если вы планируете осуществлять фильтрацию пакетов.  
**CONFIG_IP_NF_TARGET_REJECT** - добавляется действие REJECT, обеспечивающее передачу ICMP-сообщения об ошибке в ответ на входящий пакет, отвергаемый заданным правилом. TCP-соединения, в отличие от UDP и ICMP, всегда завершаются или отвергаются пакетом TCP RST.  
**CONFIG_IP_NF_TARGET_MIRROR** - возможность отправки обратно полученного пакета, поменяв местами адреса отправителя и получателя (отражение).  
**CONFIG_IP_NF_NAT** - NAT, т. е. трансляция сетевых адресов в различных ее видах. С помощью этой опции вы сможете предоставить выход в Интернет всем компьютерам локальной сети при наличии лишь одного уникального IP-адреса.  
**CONFIG_IP_NF_TARGET_MASQUERADE** - маскарадинг, в отличие от NAT используемый тогда, когда IP-адрес в Интернете неизвестен заранее, т.е. для DHCP, PPP, SLIP или какого-либо другого способа подключения, подразумевающего динамическое получение IP-адреса. Маскарадинг несколько повышает высокую нагрузку на компьютер по сравнению с NAT, однако он работает в таких ситуациях, когда нельзя заранее указать собственный внешний IP-адрес.  
**CONFIG_IP_NF_TARGET_REDIRECT** - перенаправление. Вместо того чтобы просто пропустить пакет дальше, это действие перенаправляет его на другой порт сетевого экрана. Обычно это действие применяется совместно с proxy. Иными словами, есть возможность выполнять <прозрачное проксирование>.  
**CONFIG_IP_NF_TARGET_LOG** - модуль добавляет действие LOG в iptables, фиксирует отдельные пакеты в системном журнале (syslog), что бывает весьма полезно при отладке сценариев.  
**CONFIG_IP_NF_TARGET_TCPMSS** - опция, помогающая преодолевать ограничения, накладываемые отдельными провайдерами (Internet Service Providers), блокирующими пакеты ICMP Fragmentation Needed.  
**CONFIG_IP_NF_COMPAT_IPCHAINS** - добавляет совместимость с более старой технологией ipchains. Вполне возможно, что совместимость подобного рода будет сохранена и в ядрах серии 2.6.x.  
**CONFIG_IP_NF_COMPAT_IPFWADM** - обеспечивает совместимость с ipfwadm, несмотря на то, что это очень старое средство построения брандмауэров.

Информация по конфигурированию и установке брандмауэра находится в файле INSTALL. После изменения конфигурации ядра его необходимо перекомпилировать и установить.

Устанавливаем iptables:
  emerge -av iptables

##  Настройка для одной машины
```
# Создаем цепь которая блокирует новые соединения, исключая те которые исходят изнутри сети.
iptables -N block
iptables -A block -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A block -m state --state NEW -i ! ppp0 -j ACCEPT
iptables -A block -j DROP

# Назначим всему входящему и маршрутизируемому траффику проход через наше правило.
iptables -A INPUT -j block
iptables -A FORWARD -j block
```

---------------------------
Ссылки:

[Red Hat Enterprise Linux 4. Руководство по безопасности](http://www.rhd.ru/docs/manuals/enterprise/RHEL-4-Manual/security-guide/index.html)  
[Iptables Tutorial 1.1.16](http://rus-linux.net/MyLDP/sec/iptables-tutorial.html)  
[Как пакеты проходят фильтры](http://rus-linux.net/MyLDP/HOWTO-ru/Packet-Filtering-HOWTO/packet-filtering-HOWTO-6.html)  
[Иммунитет для Linux](http://www.compdoc.ru/os/Linux/immunitet/)  
[Linux для начинающих: работа в сети](http://www.compdoc.ru/os/Linux/work-in-network/)  
["Огненная стена" или строим файрвол на базе iptables](http://linuxportal.ru/entry.php/P1730_0_3_0/)  
[Защищаем Линукс - файрвол за 10 минут](http://asplinux.net/node/18)  
