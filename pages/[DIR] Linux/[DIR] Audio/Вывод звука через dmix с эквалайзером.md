#  Вывод звука через dmix с эквалайзером

##  Цель
Как настроить звук в linux, чтобы он работал одновременно (параллельно) для нескольких приложений. Плюс пропустить его через общий эквалайзер.
##  Микшер
Для сведения звуков будем использовать программный микшер dmix, который идет уже в поставке свежих версий alsa. Его достаточно просто сконфигурировать. Для этого редактируем файл /etc/asound.conf, описав следующим образом:
```
# Устаройство dmixer - занимается сведением звуковых потоков.
pcm.dmixer  {
   type dmix
   ipc_key 1024
   ipc_perm 0666  # необходимо, чтобы разные пользователи могли одновременно работать с dmix
   slave {
       pcm "hw:0,0"
       period_time 0
       period_size 1024
       buffer_size 8192
       rate 44100
   }
   bindings {
       0 0
       1 1
   }
}

# контроль-микшер
ctl.mixer0 {
   type hw
   card 0
}

# устройство по умолчанию
pcm.!default {
   type plug
   slave.pcm "dmixer"
}

# устройство dsp0
pcm.dsp0 {
   type plug
   slave.pcm "dmixer"
}
```
После чего надо перезапустить alsa
  /etc/init.d/alsasound restart
##  Эквалайзер
Эквалайзер будем подключать к alsa до dmixer-а. Примерно так, как показано на схеме:
  Программа -> Виртуальное устройство (dsp0) -> Эквалайзер (alsaequal) -> Микшер (dmixer) -> Звуковая карта (hw:0,0)

Довольно удобный эквалайзер в Linux для alsa это alsaequal. Ставим его:
  emerge media-plugins/alsaequal

Подключить его можно так же редактируя конфиг /etc/asound.conf:
```
# подключаемый эквалайзер с выходом на dmixer
pcm.plugequal {
 type equal;
 slave.pcm "plug:dmixer"
}

# контроль эквалайзера
ctl.equal {
 type equal;
}

# Устаройство dmixer - занимается сведением звуковых потоков.
pcm.dmixer  {
   type dmix
   ipc_key 1024
   ipc_perm 0666  # необходимо, чтобы разные пользователи могли одновременно работать с dmix
   slave {
       pcm "hw:0,0"
       period_time 0
       period_size 1024
       buffer_size 8192
       rate 44100
   }
   bindings {
       0 0
       1 1
   }
}

# контроль-микшер
ctl.mixer0 {
   type hw
   card 0
}

#! Внимание! Теперь надо перенаправить устройства на plugequal вместо dmixer
pcm.dsp0 {
   type plug
   slave.pcm "plugequal"
}

# устройство по умолчанию
pcm.!default {
   type plug
#   slave.pcm "dmixer"   # выводить через dmixer
   slave.pcm "plugequal" # выводить через эквалайзер
```
После чего надо перезапустить alsa
  /etc/init.d/alsasound restart

**Внимание!** Если у вас к примеру 64-битная архитектура, но запускаются или эмулируются 32 битные приложения - default лучше оставить указывающим на dmixer, т.к. alsa скорее всего не сможет найти 32-битную версию equal, и выведет ошибку по типу:
  /usr/lib32/alsa-lib/libasound_module_pcm_equal.so not found

##  Проверяем
Запустить графический эквалайзер можно командой
  alsamixer -D equal

либо просто запустив alsamixer, затем нажав F6 и в выборе звуковых карт вписав имя equal.
###  mplayer
По умолчанию mplayer (да и другое ПО) должны сами подключаться к устройству по умолчанию, но им можно задать и конкретно. К примеру для mplayer это параметры:
  mplayer -ao alsa:device=dsp0 ./file.ogg

Так же можно этот параметр поместить в ~/.mplayer/config :
  ao=alsa:device=dsp0
###  mpd
В конфиге /etc/mpd.conf можно указать устройство, через которое требуется выводить звук:
```
audio_output {
  type    "alsa"
  name    "equal"
  device  "plug:plugequal"
}
```
**Внимание!** Т.к. equal хранит настройки эквалайзера для каждого пользователя отдельно в файле ~/.alsaequal.bin, то ПО, исполняющиеся от другого пользователя не увидит ваш конфиг эквалайзера. В частности если mpd работает от пользователя mpd, то отредактировать эквалайзер можно от этого пользователя:
  sudo -u mpd alsamixer -D euqal

либо сделав общий конфиг (симлинкой).
###  wine
Если в wine эмулируется 32-битные приложения под 64-битным хостом - рекомендуется в winecfg выбрать OSS, тогда он подцепится к устройству по-умолчанию. Для этого надо сделать по-умолчанию устройство dmixer. К сожалению эквалайзера в таком случаи для wine не получится, зато другие приложения смогут выводить звук параллельно с ним.
