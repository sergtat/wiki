#  Почтовая система
##  Выбор формата ящика
"**Maildir** — это распространённый формат хранения электронной почты, не требующий монопольного захвата файла для обеспечения целостности почтового ящика при чтении, добавлении или изменении сообщений. Каждое сообщение хранится в отдельном файле. Все изменения делаются при помощи атомарных файловых операций, таким образом, монопольный захват файла ни в каком случае не нужен. Maildir — это каталог (чаще всего с именем Maildir) с тремя подкаталогами: tmp, new и cur.

При доставке сообщения оно помещается в файл в подкаталоге tmp (например, SMTP сервером postfix), имя файла формируется из текущего времени, имени хоста, идентификатора процесса, создавшего этот файл, и некоторого случайного числа — таким образом, гарантируется уникальность имен файлов. После записи в файл всего сообщения создается жесткая ссылка на этот файл в каталоге new, а текущая ссылка из tmp удаляется — это делается для того, чтобы никакой другой процесс не смог прочитать содержимое сообщения до тех пор, оно не будет записано полностью. По такому же алгоритму при чтении сообщения (это может делать как MUA, так и другой MDA, предоставляющий доступ к Maildir по протоколу POP3 или IMAP) оно перемещается в каталог cur, при этом название файла изменяется: к нему добавляются пометки о прочтении, ответе, удалении и т. д." (c) Wiki (рус.)

"Bernstein придумал для qmail формат Maildir, в котором каждое почтовое сообщение хранится в отдельном файле. В отличие формата Mbox — стандарта de facto, который хранит все сообщения в одном файле, Maildir позволяет избежать множества проблем с блокировками и параллелизмом, также, он безопасно может работать поверх NFS." (c) QMail Wiki.

**MBox** - почтовые сообщения хранятся в одном файле. Формат **mbox** был стандартом в Unix со дня рождения Unix.

**mbox** морально устарел и множественные проблемы с блокировками.

Выбираем **maildir**.

##  Отправка почты (MTA)
MUA (Mail User Agent) - попросту почтовая программа отправляет письмо на порт 25 (smtp) либо 465 (ssmtp) провайдера. А как же программы которые шлют сообщения (в-первую очередь cron), они ничего не знают про провайдера и вашу почтовую программу. Можно поставить простенький MTA-relay (ssmtp, nbsmtp, msmtp и.т.д.), но они работают только в режиме relay, то есть перенаправляют на другой MTA и мы сможем смотреть системные сообщения только с удаленного сервера.
Нужен собственный smtp-сервер MTA (Mail Transport Agent) для раскладывания и отправки почты. Из наиболее  распространенных (**sendmail, qmail, exim, postfix**) я выберу **postfix**, на него очень много документации и примеров в интернете, хорошо развивается.

###  Postfix для локальной почты
После установки postfix необходимо отредактировать его главный конфигурационный файл /etc/postfix/main.cf. Этот файл довольно длинный, и вы должны оставить его по существу без изменений. Ниже я покажу только линии, которые должны быть изменены.
```
myhostname = localhost
mydomain = localdomain
inet_interfaces = $myhostname, localhost
mydestination = $myhostname, localhost.$mydomain, localhost
mynetworks_style = host
```
Первые две строки задать hostname и domain почтовой системы. Переменная inet_interfaces адреса сетевого интерфейса, на которых почта будет получена. Переменная mydestination указывает список доменов, для которых машина считает себя конечным пунктом назначения. Измените эти строки именно так, как указано выше.

Кроме того, добавьте следующее в /etc/postfix/main.cf, чтобы отключить доставку нелокальной почты:
```
default_transport = error:outside mail is not deliverable
```
Переменная default_transport определяет, какой транспорт используется для доставки нелокальной почты (по умолчанию SMTP). При этой установке вся внешней почты будут возвращаться с ошибкой.

Если вы предпочитаете Maildir формат, сделайте
```
home_mailbox = Maildir/
```
для хранения сообщений в подкаталоге Maildir вашего домашнего каталога. Обратите внимание на /, это говорит Postfix доставлять почту в Maildir.

####Тестирование конфигурации и запуск службы
Когда настройка завершена вы можете проверить, если что все установлено правильно:
```
postfix upgrade-configuration
postfix check
```
Также не забудьте запустить
```
newaliases
```
даже если вы не меняете /etc/mail/aliases, Postfix не будет работать правильно, без alias database /etc/mail/aliases.db.  

Если все в порядке запустите сервис:
```
/etc/init.d/postfix start
```
и добавьте его в уровень запуска по умолчанию
```  
rc-update add postfix default
```
Попробуйте отправить письмо самому себе. Воспользуйтесь например командой mail или mailx:
```  
echo "текст письма" | mail -s "заголовок" user
```
Если в папке $USER/.maildir появилось новое письмо - тест пройден.

####Mail Aliases
Если Вы не хотите каждый раз заходить рутом, чтобы прочитать системные сообщения, добавьте псевдонимы в /etc/mail/aliases
```  
root:               username
operator:           username
```
не забудьте обновить базу данных псевдонимов
```  
newaliases
```
####Сценарий проверки почты
Сценарий будет уведомлять вас о новых письмах почтовой системы каждый раз, когда вы откроете терминал.
```
if [ -d "${HOME}/.maildir/new" ]
  then NEWMAIL=`find ${HOME}/.maildir/new/ -type f`
  if [ ! -z "${NEWMAIL}" ]
    then echo "You have new mail. Read it with 'mutt'."
  fi
fi
```
или если используете bash
```  
echo "MAILCHECK=30" >> ~/.bashrc
echo 'MAILPATH=~/.maildir/new?"You have a new mail. Read it with 'mutt'."' >> ~/.bashrc
```

###  Postfix для остальной почты
Немного меняем настройки в /etc/postfix/main.cf
```
queue_directory = /var/spool/postfix
command_directory = /usr/sbin
daemon_directory = /usr/lib/postfix
mail_owner = postfix
myorigin = $myhostname
unknown_local_recipient_reject_code = 450
mynetworks_style = subnet
mynetworks = 127.0.0.0/8 192.168.2.0/24 # Ваша сеть
mailbox_command = /usr/bin/procmail
debug_peer_level = 2
debugger_command =
  PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin:
  xxgdb = $daemon_directory/$process_name $process_id & sleep 5
sendmail_path = /usr/sbin/sendmail
newaliases_path = /usr/bin/newaliases
mailq_path = /usr/bin/mailq
setgid_group = postdrop
manpage_directory = /usr/share/man
readme_directory = /usr/share/doc/postfix-2.1.5-r2/readme
default_destination_concurrency_limit = 2
alias_database = hash:/etc/mail/aliases
local_destination_concurrency_limit = 2
alias_maps = hash:/etc/mail/aliases
home_mailbox = .maildir/
#default_transport =
```
####  Через релей
Добавляем в /etc/postfix/main.cf
```
relayhost = [smtp.youisp.ru] # smtp вашего провайдера
```
Проверяем.

####  Через релей с аутентификацией
1. postfix должен быть собран с поддержкой sasl.
2. создать файлик saslpass (например) в /etc/postfix с паролями
3. в main.cf добавить: 

    ```
    relayhost = [smtp.youisp.ru] # smtp вашего провайдера
    smtp_sasl_auth_enable = yes
    smtp_sasl_password_maps = hash:/etc/postfix/saslpass
    smtp_sasl_security_options = noanonymous
    ```
4. В saslpass пишем:

    ```
    [smtp.youisp.ru] login:password # Ваши данные
    ```
5. создаем базу:

    ```
    postmap /etc/postfix/saslpass
    ```
Эта команда создаёт (обновляет) соотвествующую базу, которая задаётся одноимённым конфигом. Postfix при работе берёт информацию не из конфига, а из базы. Конфиг лишь готовит информацию для базы. Данную команду необходимо выполнять после любых изменений конфига.

####  Напрямую со статическим IP
FIXME

####  Напрямую с динамическим IP
FIXME

##  Доставка почты (MDA)
Mail Delivery Agent (MDA, Агент доставки электронной почты) — программа, принимающая входящие электронные письма и доставляющая их на электронный ящик получателя (если адрес назначения расположен на том же компьютере) или перенаправляющая их на другой почтовый сервер (если адрес назначения расположен на другом компьютере).

Задачи программы доставки почты заключаются в следующем:
- Получение почты с pop3-сервера;
- Передача писем программе обработки почты;
Рассмотрим две программы данного типа: fetchmail и getmail. Они очень сильно различаются по возможностям. Fetchmail работает с большим количеством протоколов (POP2, POP3, RPOP, APOP, KPOP, IMAP4 и другие) и имеет огромное количество различных функций. Getmail, наоборот, работает только с POP3, но многим она больше нравится за свою простоту.

