# Gentoo. Инструкции по обновлению

> Многие считают gentoo плохим дистрибутивом из-за его сложности и низкой стабильности. За пару лет использования этого дистра могу сказать, что основная масса проблем, преследовавших меня меня ранее возникала из-за не правильного обновления и не понимания того, как собираются программы из исходников в юникс-подобных. Сдесь собраны правила, которые и выработал для себя, и таки следую им. Возможно они кому-то и пригодятся.

1. Если пакет не собирается, а в логе сборки есть слово `perl`.
Скорее всего дело в том, что после обновления перла поломались биндинги к библиотекам или другие модули перла. Чтобы решить проблему надо выполнить
    #perl-cleaner --allmodules  
Естественно, что для этого у вас должен быть установлен пакет `perl-cleaner`. Такая проблема часто возникает со сборкой `vim` после обновления перла.
2. То же самое, только слово `perl` заменить словом python и строку с `perl-cleaner` заменить на
    #python-updater  
сам скрипт `python-updater` лежит в одноименном пакете.
3. Если пакет не собирается, а в логе сборки есть что-то типа "не могу найти библиотеку `lib-blabla.la`".
Скорее всего, дело в `*.la` файлах, которые используются `libtools` для сборки, чтобы решить проблему надо выполнить
    #lafilefixer  --justfixit  
после чего `emerge --resume` и продолжить сборку. Для этого у вас должен быть установлен пакет `lafilefixer`.
4. Если пакет не собирается, а в логе сборки странные сообщения компилятора о синтаксических ошибках в коде, или отсутствии функции, на которую ссылается один объектник, но которой нет ни в одном другом линкуемом объектнике.
Почти наверняка вам надо выполнить `revdep-rebuild`. Пакет, в котором он находится - `gentoolkit`, должен стоять в системе у любого гентушника в обязательном порядке, как `portage`.
5. `revdep-rebuild` после каждого обновления. Это действительно спасает от многих проблем. Даже если ревдеп не нашел поломанных связей, всегда лучше потратить 5 минут на их поиск и быть уверенным, что все бинари линкуются без проблем, и всякие там сегфолты возникают из-за проблем в программе.
6. Выполнять `etc-update` после каждого, даже самого незначительного обновления. Был случай, когда из-за не обновленных конфигов не собирался пакет (уже не помню какой, конечно). А если обновился такой пакет как `udev`, то вы можете просто не загрузиться.
7. Если сборка прервалась по одной из причин, и обновление затянулось на несколько дней, не желательно обновлять порты (исключением будет, пожалуй, случай, когда в портах пришло исправление, без которого не собрать пакет), это может затронуть уже собранные (обновленные) пакеты. Например обновится библиотека `glib`, и это потребует пересборки `gtk`, в любом случае обновление может затянуться еще на дольше. Лучше всего сделать `revdep-rebuild` после проблем со сборкой, чтобы система стала линкуемой и чистой.
8. Если никак не удается обновить пакет, то его можно и замаскировать. Например не могу я собрать `sys-libs/glibc-2.11.2-r2` просто делаю
    # echo "=sys-libs/glibc-2.11.2-r2" >> /etc/portage/package.mask  
и продолжаю сборку `emerge --resume`. Иногда один из пакетов требует по зависимости именно ту версию проблемного пакета, которую вы не можете собрать. Самый простой способ узнать, какой пакет требует проблемный пакет по зависимости (и почему эта зависимость есть) - это замаскировать проблемный пакет, и посмотреть что скажет `portage` когда вы попытаетесь обновиться. На человеческом языке будет написано какой пакет требует сборки вашей проблемы, и почему. Некоторые зависимости пакетов появляются только вместе с включенными флагами, чтобы узнать, какой флаг включает в зависимость вашу проблему, можно просто посмотреть `ebuild` этого пакета. Так что, если флаг не нужен, можно смело его выключать в `/etc/portage/package.use` тогда зависимость пропадет, и проблемный пакет обновлен не будет.
9. `emerge --depclean` после каждого обновления. Это не критичное правило, но, всегда приятно, когда в системе нет лишних пакетов (например, поставленных с `emerge -1 blabla` и забытых), в некоторых случаях установленные в системе пакеты могут влиять на сборку других пакетов, особенно, если эти другие пакеты собираются при помощи `autotools`.
10. Если вы обновляете генту на машине, за которой не можете постоянно следить, и хотели бы собрать максимум пакетов из тех, что можно собрать (ведь сборка частенько может прерваться из-за различных причин и тогда обновление просто прервется), лучший способ - это параметр `--keep-going` для `emerge`
    >>emerge --keep-going -uND world  
Примерно так. Если `portage` наткнется на пакет, который не может собрать или установить, она просто выкидывает его из списка обновления, потом перевычисляет дерево зависимостей с учетом, что "вот этот пакет собрать нельзя" и продолжяет сборку. Так она продолжает попытки обновления системы из тех пакетов что возможно собрать сдесь и сейчас.
Так что, когда вы придете посмотреть что же там наобновлялось в вашей генте, то, в лучшем случае, обнаружите, что все обновилось нормально, в худшем - узнаете какие пакеты собрать не удалось (или установить) и почему.
11. Некоторые порты (особенно порты для одного пакеты из разных оверлеев) не учитывают конфликтов с другими портами, которые установлены у вас в системе.
Пример: `app-text/poppler` из официального дерева и из оверлея `sabayon`, в котором пакет разбит на несколько (отдельно хедеры, отдельно биндинги для `QT` ну и так далее). При установке `poppler` из оверлея `sabayon` возникают коллизии файлов, это потому, что в порте из `sabayon` не указан конфликт с гентушным `poppler` в результате последний не удаляется `portage` перед установкой первого.
Чтобы броться с таким безобразием поможет ручное удаление конфликтного пакета примерно вот так:
    >>emerge -C $(qlist -IC poppler) && emerge -uND poppler && revdep-rebuild  
Не всегда можно однозначно определить, что за пакет мешает установке, чтобы это узнать нужно сделать вот так:
    >>equery b $file  
Где `$file` - полный путь до одного из файлов, который указан в списке коллизий файлов, который выводит `portage`.
12. После обновления `x11-base/xorg-server` весьма желательно выполнять
    >>emerge -1 $(qlist -IC x11-drivers)  
Это пересоберет все иксовые драйверы в системе, и убережет вас от неработающей клавиатуры и мыши во время первого логина после перезагрузки :).
Если ничего не помогло, ваш путь - багтрекер. Гентушный багтрекер на удивление живой, можете рассчитывать на то, что вашу проблему решат за час, если проблема не в портах, а ваших руках :). Если нет, то вы принесете пользу сообществу, и ошибку в портах исправят втечение нескольких дней, что будет, несомненно, полезно не только вам. Если ошибка не в портах, а в самой программе, то информация о баге будет передана в апстрим (разработчику) что тоже очень полезно.

[Источник](http://s9gf4ult.blogspot.ru/2010/12/gentoo.html)
