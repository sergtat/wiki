# Удаленное управление теплом в гараже
![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_001.jpg 'Удаленное управление теплом в гараже')

Для обогрева своего гаража, я использую 2 "конвектора". Один конвектор включен постоянно на +5 градусов, для поддержания плюсовой температуры, второй "конвектор" включается по необходимости.

Раньше приходилось бегать, включать его, уходить домой, ждать час-два пока температура поднимется до комфортных +20, но это быстро надоело, одолела лень и я решил применить максимально бюджетный вариант удаленного включения на Arduino.

## Что необходимо было купить:

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_002.jpg 'Удаленное управление теплом в гараже')  
_Arduino nano 146 руб_

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_003.jpg 'Удаленное управление теплом в гараже')  
_Модуль ENC28J60 165 руб_

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_004.jpg 'Удаленное управление теплом в гараже')  
_Датчик температуры DHT22 151руб_

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_005.jpg 'Удаленное управление теплом в гараже')  
_Реле 40руб_

## Коротко о подключении всего этого барахла.

**Модуль ENC28J60:**

- VCC к 5V
- GND к GND
- SCK к Pin 13
- SO к Pin 12
- ST к Pin 11
- CS к Pin 10

**Реле:**

- S к Pin 2
- Vcc к 5V
- GND к GND

**Датчик температуры DHT22:**

- Vcc к 3.3V
- GND к GND
- DATA к Pin4

Здесь все понятно без схем, если не понятно, в интернете есть масса материала о том, как подключать эти модули. А вот готового скетча, я не нашел, да и искать было лень… Проще было найти скетч управления реле и скетч вывода данных с датчика, скрестить их и набросать страницу, чтоб ей было удобно управлять с телефона и обычного ПК.

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_006.jpg 'Удаленное управление теплом в гараже')

## Скетч получился вот такой:

```c
#include "DHT.h"
#include <EEPROM.h>
#define DHTPIN 4
#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);
#include <EtherCard.h>
static byte mymac[] = { 0x74,0x69,0x69,0x2D,0x30,0x31 }; // MAC Address должен быть уникальным в локальной сети
static byte myip[] = { 192,168,1,222 }; // Постоянный IP адресс нашей страницы
byte Ethernet::buffer[1000];
BufferFiller bfill;
// Начальные данные
int LedPins[] = {
2,3,5,6,7,8,9};
int t=0;
int h=0;
boolean PinStatus[7];
const char http_OK[] PROGMEM =
"HTTP/1.0 200 OK\r\n"
"Content-Type: text/html\r\n"
"Pragma: no-cache\r\n\r\n"
"\r\n"
"<meta charset='UTF-8'>"
"<meta name='viewport' content='width=device-width, initial-scale=1.0'>"
"<meta http-equiv='refresh' content='10'/>";
const char http_Found[] PROGMEM =
"HTTP/1.0 302 Found\r\n"
"Location: /\r\n\r\n";
const char http_Unauthorized[] PROGMEM =
"HTTP/1.0 401 Unauthorized\r\n"
"Content-Type: text/html\r\n\r\n"
"<h1>401 Unauthorized</h1>";
// Подключаем Ethernet порт HR911105A и датчик DHT22
void setup () {
if (ether.begin(sizeof Ethernet::buffer, mymac, 10) == 0)
Serial.println( "Failed to access Ethernet controller");
ether.staticSetup(myip);
for(int i = 0; i <= 7; i++)
{
pinMode(LedPins[i],OUTPUT);
PinStatus[i]=EEPROM.read(i);
digitalWrite(LedPins[i],PinStatus[i]);
}
dht.begin();
}
// Получаем данные от DHT22
static void ReadDHT22()
{
h = dht.readHumidity();
t = dht.readTemperature();
}
// Оформление Web страницы
static word homePage() {
bfill = ether.tcpOffset();
bfill.emit_p(PSTR("$F"
"<title>Гараж</title>"
"<p style=\"text-align: center;\"><br />Конвектор: <br> <span style=\"font-size: 4em;\"><a href=\"?ArduinoPIN2=$F\">$F</a></span>"),
http_OK,
PinStatus[0]?PSTR("off"):PSTR("on"),
PinStatus[0]?PSTR("<font color=\"green\"><b>ON</b></font>"):PSTR("<font color=\"red\">OFF</font>"));
bfill.emit_p(PSTR(
"<br><br>Температура: <br> <span style=\"font-size: 4em;\">$D C</span> <br /><br />Влажность:<br> <span style=\"font-size: 4em;\"> $D %</span></p>"),t, h);
return bfill.position();
}
void loop () {
delay(1); // Задержка
word len = ether.packetReceive();
word pos = ether.packetLoop(len);
if (pos) // check if valid tcp data is received
{
ReadDHT22();
bfill = ether.tcpOffset();
char *data = (char *) Ethernet::buffer + pos;
if (strncmp("GET /", data, 5) != 0) {
bfill.emit_p(http_Unauthorized);
}
else {
data += 5;
if (data[0] == ' ') {
homePage();
}
else if (strncmp("?ArduinoPIN2=on ", data, 16) == 0) {
PinStatus[0] = true;
digitalWrite(LedPins[0],PinStatus[0]);
EEPROM.write(0,PinStatus[0]); // записываем в ячейку EEPROM №0, текущее состояние LedPins[0].
bfill.emit_p(http_Found);
}
else if (strncmp("?ArduinoPIN2=off ", data, 17) == 0) {
PinStatus[0] = false;
digitalWrite(LedPins[0],PinStatus[0]);
EEPROM.write(0,PinStatus[0]);
bfill.emit_p(http_Found);
}
else {
// Page not found
bfill.emit_p(http_Unauthorized);
}
}
ether.httpServerReply(bfill.position()); // send http response
}
}
```

## Коротко о данном скетче:
В память ардуины (EEPROM) сохраняется информация о последнем положении кнопки реле, перебои со светом нам не страшны, положение кнопки всегда отражает реальное состояние реле, не будет такого, что на странице выводится OFF а на самом деле ON.

Далее подключаю сборку к локалке, для питания использую старую зарядку от мобильного телефона.

Вызываю страницу по IP адресу, который мы задали в начале скетча: http://192.168.1.222

**Получаю страницу с данными:**

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_007.jpg 'Удаленное управление теплом в гараже')

Всё открывается, данные с датчика верные, реле на нажатие кнопки реагирует, положение запоминает.

Далее нужен корпус. Можно заколхозить из какого-нибудь пластикового контейнера, или заказать на али типовой пластиковый корпус для подобного барахла, или купить распределительную коробку в электротоварах, но мне лень выходить из дома, поэтому, я по-быстрому накидал в солиде уродца и распечатал его на 3D принтере.

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_008.jpg 'Удаленное управление теплом в гараже')

**Крышка:**

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_009.jpg 'Удаленное управление теплом в гараже')

**Процесс печати:**

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_010.jpg 'Удаленное управление теплом в гараже')

**Собрал все в корпус, закрепил модули термоклеем:**

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_011.jpg 'Удаленное управление теплом в гараже')

**Установил крышку, держится и без шурупов, можно было и не предусматривать отверстия под них.**

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_012.jpg 'Удаленное управление теплом в гараже')

Когда моделировал корпус, особо головой не думал, по этому реле почему-то сделал по середине… Лучше было его разместить с краю. Ну да ладно, и так сойдет…

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_013.jpg 'Удаленное управление теплом в гараже')

Притащил все в гараж, подключил, проверил. Вывел двойную розетку т.к. одинарной под руками не было.

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_014.jpg 'Удаленное управление теплом в гараже')

Вывел датчик DHT22 примерно на среднюю высоту стены, т.к. конвекторы сильно греют потолок, а пол помещения долго остается прохладным.

Датчик кстати оснащен и гигрометром, это очень хорошо, т.к. в мастерской я работаю с деревом, знать о текущей влажности воздуха очень полезно.
Провел интернет в гараж. Купил недорогую направленную Wi-Fi антенну, поставил её на карниз пока вот так, летом если дойдут руки и не будет лень сделаю нормальный кронштейн.

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_015.jpg 'Удаленное управление теплом в гараже')

В гараже установил обычную точку доступа и настроил её как адаптер. Поймал сигнал от направленной антенны, которая без труда пробила стену гаража, поставил небольшой коммутатор и подключил к нему нашу систему.

Теперь гараж с домом у нас в одной сети и самое время настроить виртуальный сервер на домашнем роутере.

Прописываем порт который мы открываем например 7777, прописываем IP нашей системы 192.168.1.222, прописываем порт по которому будет доступна наша страница, для доступа из браузера порт 80.

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_016.jpg 'Удаленное управление теплом в гараже')

При наличии статического IP адреса от провайдера, наша система теперь доступна откуда угодно по адресу http://нашip:порт

Если провайдер не предоставляет статический IP, можно сделать и другими способами, но для этого потребуется всегда включенный ПК в доме.

У меня есть статика и зарегистрированный домен, к поддомену которого, я привязал свою систему и мне нет необходимости помнить свой IP для доступа к управлению.

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_017.jpg 'Удаленное управление теплом в гараже')

Не знаю, как на андроиде, а на айфоне можно вывести закладку на экран, она будет доступна как приложение, тем самым мы имеем быстрый доступ к нашей системе без лишних телодвижений и рытья в закладках.

![Удаленное управление теплом в гараже](/images/Village/obogrev_garazha_018.jpg 'Удаленное управление теплом в гараже')

Далее в планах сделать автоматическую вытяжку при большой влажности или задымленности. Задымленность появляется, когда работаешь фрезером или, когда работает лазерный станок.

**Спасибо за внимание.**

**Источник**: http://www.yaplakal.com
