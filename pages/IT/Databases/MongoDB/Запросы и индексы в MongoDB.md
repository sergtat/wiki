# Запросы и индексы в MongoDB.
## Индексы
Индексы в MongoDB, так же как и в РСУБД используются для ускорения работы запросов. Индексы реализованы в виде B-деревьев.

MongoDB всегда вместе с коллекцией создаёт индекс по полю `_id`.

Для создания индекса используется команда:

```javascript
db.things.ensureIndex({name: 1})
```

Things - коллекция, name - имя поля. 1 означает, что индекс выстраивается по возрастанию, -1 по убыванию.

Можно создавать составные индексы указывая несколько полей:
```javascript
db.things.ensureIndex({name: 1, y: -1})
```
При создании составных индексов нужно помнить, что MongoDB будет использовать их при обработке запросов, только в том случае, когда в запросе поля указаны в том же порядке, что и в индексе.

Например: составной индекс по полям a, b, c.

MongoDB будет использовать этот индекс если в запросе указано:

- a
- a, b
- a, b, c

Если поле является массивом значений, то при его индексировании индексируются все элементы массива.

При создании индексов можно указывать дополнительные параметры:

1. background (true/false). Создание индекса в фоне.
2. unique (true/false). Создаётся индекс с уникальными значениями. При наличии не уникальных значений в поле вернёт ошибку;
3. dropDubs (true/false). Используется если необходимо создать уникальный индекс по полю с дублирующимися значениями. Документы с дублирующимися значениями просто удаляются. Используется в паре с unique;
4. sparce (true/false). С этой опцией индекс может быть создан по полю, отсутствующему в некоторых документах. При этом эти документы не попадают в индекс.

Удаление всех индексов:

```javascript
db.things.dropIndexes()
```

Удаление одного индекса:

```javascript
db.things.dropIndex({name: 1})
```

Переиндексация:

```javascript
db.things.reIndex()
```

## Запросы в MongoDB

### Запрос Find

Find аналог select в SQL. Find возвращает массив документов в виде коллекции, если по запросу ничего не найдено вернётся пустая коллекция.

```javascript
db.things.find({name: 'Pen'})
```

Запрос ищет все вещи с именем Pen. При этом выведутся все поля документа.

Что бы выводить только нужные поля:

```javascript
db.things.find({}, {name: 1})
```

Запрос вернёт все документы в коллекции, при этом выведет только два поля: `_id` и `name`.

Перечисление полей через запятую образует И, если нужно реализовать ИЛИ, то используется специальный оператор $or

```javascript
db.unicorns.find({gender: 'f', $or: [{loves: 'apple'}, {loves: 'orange'}]})
```

Ищем всех единорогов женского пола, любящих или яблоки или апельсины.

Можно использовать различные условия, а не только равенство. 

Операторы: $lt — меньше, $lte — меньше или равно, $gt — больше, $gte — больше или равно, $ne — не равно. 

Ещё есть оператор $exists (true/false), с помощью которого можно проверить существует ли поле: 

```javascript
db.unicorns.find({gender: {$in: [f], $exists: true}})
```

Выведет все документы с полем gender равным f.

В запросе выше был использован оператор $in который проверяет является ли значение поля одним из заданных в квадратных скобках. Противоположность этого оператора $nin.

Так же в условиях можно использовать Perl-подобные регулярные выражения:

```javascript
db.things.find({name: /^joe$/i });
```

Запросы к массивам значений выполняются так же как к обычным полям. Вам ничего дополнительно делать не нужно. Например в примере с единорогами поле loves является массивом значений.

В запросах на месте условия в общем случае можно написать JavaScript функцию, которая возвращает true/false указывающий на включение или не включение документа в результат. В функции доступен текущий документ через ключевое слово this.

```javascript
db.things.find({$where: function() {return (this.cost>5 && this.cost<10)});
```

### Ограничение на количество получаемых документов

Результирующую коллекцию можно ограничить с помощью команд limit, skip.

Limit задаёт количество документов, которое необходимо вывести. 

Skip пропускает указанное количество документов и выводит остальные.

```javascript
db.unicorns.find().sort({weight: -1}).limit(2).skip(1)
```


Этот запрос получает второго и третьего по весу единорога.

Для получения одного документа так же можно использовать запрос findOne, который возвращает первый найденный документ.

### Sort

В примере выше уже использовалась команда sort, которая сортирует результаты запроса. При сортировке можно указывать несколько полей, и так же как при создании индексов 1 означает сортировку по возрастанию, а -1 по убыванию.

### Запрос Insert

Insert отвечает за вставку данных в коллекцию.  

```javascript
db.unicorns.insert({name: 'Horny', dob: new Date(1992,2,13,7,47), loves: ['carrot','papaya'], weight: 600, gender: 'm', vampires: 63});
```

Если коллекции unicorns до запрос не существовало, то она будет создана.

### Запрос Remove

Запрос Remove без параметров удалит все документы в коллекции. 

Для удаления нужных документов необходимо задать условие так же как это делалось в find.

### Запрос Update

Update обновляет данные в документе, но его использование несколько не похоже на SQL запрос Update. Первым параметром в запросе идёт условие, которое определяет какой документ обновлять, потом идёт то, что нужно обновить.

```javascript
db.unicorns.update({name: 'Roooooodles'}, {weight: 590})
```

Такой запрос найдёт единорога с именем Roooooodles, но не изменит ему вес, а заменит весь документ на weight: 590. Это происходит потому что второй параметр Update используется для полной замены оригинала.

Для замены только нужных полей используется оператор $set:

```javascript
db.unicorns.update({name: 'Roooooodles'}, {$set: {weight: 590}})
```

Есть ещё несколько модификаторов для действия над полями: 

- $inc, увеличивает поле на заданное числовое значение (можно задать отрицательное число)
- $push, добавляет в массив значений указанное значение.

Существует ещё множество других модификаторов. Подробнее можно посмотреть на вики MongoDB.

Вообще команда update принимает 4 параметра. Два из них упоминались выше.

Третий параметр указывает необходимо ли создать документ, если он не найден при попытке обновления. Принимает значение true/false. Превращает команду update в так называемую upsert от update и insert.

Четвёртый параметр принимает true/false. Указывает обновляется ли по умолчанию одни документ (false) или несколько документов (true) - все которые соответствуют условию в первом параметре.

> При написании были использованы следующие ресурсы:

> 1. http://ru.wiki.mongodb.org
> 2. http://jsman.ru/mongo-book/Vvedenie.html
> 3. http://habrahabr.ru/post/134590/
> 4. http://habrahabr.ru/post/147053/

> Источник: http://ita2010.psu.ru
